#include "fff.h"
#include <gtest/gtest.h>

extern "C" {
#include "application/estimator/ekf.h"
#include "application/estimator/estimator_types.h"
#include "arm_math.h"
#include "common/math/math-algebra3d.h"

DEFINE_FFF_GLOBALS;
}

class EstimatorEKFTest : public ::testing::Test {
protected:
    void SetUp() override {
        FFF_RESET_HISTORY();
    }

    void TearDown() override {}
};

TEST_F(EstimatorEKFTest, EKFPredictNominalCheckWithAllZerosP) {
    // Arrange
    x_state_t state = {
        .array = {
            0.814723686393179,
            0.905791937075619,
            0.126986816293506,
            0.913375856139019,
            0.632359246225410,
            0.097540404999410,
            0.278498218867048,
            0.546881519204984,
            0.957506835434298,
            0.964888535199277,
            0.157613081677548,
            0.970592781760616,
            0.957166948242946
        }
    };
    double P_flat[SIZE_STATE * SIZE_STATE] = {0};
    const u_dynamics_t input = {
        .cmd = 4.217612826262750,
        .acceleration = {.array = {1.456126946168524, 2.400841406666400, 0.425659015881646}}
    };
    double dt = 0.915735525189067;

    // set up Q like ekf_algorithm would
    static double Q_diag[SIZE_STATE] = {
        1e-9, 1e-9, 1e-9, 1e-9, 1e0, 1e0, 1e0, 1e-3, 1e-3, 1e-3, 1e-2, 1, 0
    };
    double Q_arr[SIZE_STATE * SIZE_STATE] = {0};
    arm_matrix_instance_f64 Q = {.numRows = SIZE_STATE, .numCols = SIZE_STATE, .pData = Q_arr};
    math_init_matrix_diag(&Q, (uint16_t)SIZE_STATE, Q_diag);

    x_state_t expected_state = {
        .array = {
            0.268274165208879,
            0.696419511023482,
            0.194712315844409,
            0.636487196262266,
            1.55182552860322,
            0.214769904048368,
            0.263669144587128,
            -0.400684442488099,
            8.41693588011966,
            -6.31409592104001,
            0.525564693616072,
            2.57823963701674,
            43.6101114976571
        }
    };

    double expected_P_flat[169] = {
        9.15735525189067e-10,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        9.15735525189067e-10,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        9.15735525189067e-10,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        9.15735525189067e-10,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0.915735525189067,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0.915735525189067,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0.915735525189067,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0.000915735525189067,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0.000915735525189067,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0.000915735525189067,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0.00915735525189067,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0.915735525189067,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0
    };

    // Act
    ekf_matrix_predict(&state, P_flat, &input, Q.pData, dt);

    // Assert
    double tolerance = 1e-6;

    // check x
    for (int i = 0; i < SIZE_STATE; i++) {
        EXPECT_NEAR(state.array[i], expected_state.array[i], tolerance);
    }

    // check P
    for (int i = 0; i < SIZE_STATE * SIZE_STATE; i++) {
        EXPECT_NEAR(P_flat[i], expected_P_flat[i], tolerance);
    }
}

// clang-format off
/**
 clear all;
clc;

% === SIZE DEFINITIONS ===
SIZE_STATE = 13;

% === STATE VECTOR ===
x = [
    0.814723686393179;
    0.905791937075619;
    0.126986816293506;
    0.913375856139019;
    0.632359246225410;
    0.097540404999410;
    0.278498218867048;
    0.546881519204984;
    0.957506835434298;
    0.964888535199277;
    0.157613081677548;
    0.970592781760616;
    0.957166948242946
];

% === ZERO INITIAL COVARIANCE ===
P = zeros(SIZE_STATE);

% === INPUT STRUCT ===
u.accel = [1.456126946168524; 2.400841406666400; 0.425659015881646];
u.cmd = 4.217612826262750;

% === TIME STEP ===
dt = 0.915735525189067;

% === PROCESS NOISE MATRIX Q ===
Q_diag = [1e-9*ones(1,4), 1e0*ones(1,3), 1e-3*ones(1,3), 1e-2, 1, 0];
Q = diag(Q_diag);

% === CALL PREDICTION ===
[x_out, P_out] = ekf_predict(@model_dynamics, @model_dynamics_jacobian, x, P, u, Q, dt);

% === PRINT C-STYLE OUTPUTS ===

% STATE
fprintf('// Predicted State (x_expected)\n');
fprintf('double x_expected[SIZE_STATE] = {\n');
for i = 1:SIZE_STATE
    if i < SIZE_STATE
        fprintf('    %.15g,\n', x_out(i));
    else
        fprintf('    %.15g\n', x_out(i));
    end
end
fprintf('};\n\n');

% COVARIANCE MATRIX FLATTENED
fprintf('// Predicted Covariance (P_expected)\n');
fprintf('double P_expected[SIZE_STATE * SIZE_STATE] = {\n');
for i = 1:SIZE_STATE
    for j = 1:SIZE_STATE
        idx = (i - 1) * SIZE_STATE + j;
        if idx < SIZE_STATE^2
            fprintf('    %.15g,\n', P_out(i, j));
        else
            fprintf('    %.15g\n', P_out(i, j));
        end
    end
end
fprintf('};\n');
 */
// clang-format off
 TEST_F(EstimatorEKFTest, EKFPredictNominalCheckWithNoneAllZerosP) {
    // Arrange
    x_state_t state = {
        .array = {
            0.814723686393179,
            0.905791937075619,
            0.126986816293506,
            0.913375856139019,
            0.632359246225410,
            0.097540404999410,
            0.278498218867048,
            0.546881519204984,
            0.957506835434298,
            0.964888535199277,
            0.157613081677548,
            0.970592781760616,
            0.957166948242946
        }
    };
    double P_flat[SIZE_STATE * SIZE_STATE] = {
        0.81472368639318, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.90579193707562,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.12698681629351, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.91337585613902, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.63235924622541, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.09754040499941, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.27849821886705,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.54688151920498, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.95750683543430, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.96488853519928, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.15761308167755, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.97059278176062,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.95716694824295
    };
    const u_dynamics_t input = {
        .cmd = 4.217612826262750,
        .acceleration = {.array = {1.456126946168524, 2.400841406666400, 0.425659015881646}}
    };
    double dt = 0.915735525189067;

    // set up Q like ekf_algorithm would
    static double Q_diag[SIZE_STATE] = {
        1e-9, 1e-9, 1e-9, 1e-9, 1e0, 1e0, 1e0, 1e-3, 1e-3, 1e-3, 1e-2, 1, 0
    };
    double Q_arr[SIZE_STATE * SIZE_STATE] = {0};
    arm_matrix_instance_f64 Q = {.numRows = SIZE_STATE, .numCols = SIZE_STATE, .pData = Q_arr};
    math_init_matrix_diag(&Q, (uint16_t)SIZE_STATE, Q_diag);

    x_state_t expected_state = {
        .array = {
            0.268274165208879,
            0.696419511023482,
            0.194712315844409,
            0.636487196262266,
            0.643134076016596,
            0.006279518794539,
            0.471014707988784,
            -0.400684442488099,
            8.416935880119659,
            -6.314095921040007,
            0.525564693616072,
            1.457215728968408,
            60.671289317422811
        }
    };

    double expected_P_flat[169] = {
        0.97335658135130,   -0.06567910390700,  0.00323946322590,   -0.03573628443570,
        -0.16578046094900,  -0.00407823086160,  -0.08940817458020,  -6.20764780018850,
        8.19997396823400,   2.74637204206120,   0.12583276427580,   0.00000000000000,
        0.00000000000000,   -0.06567910390700,  1.02338063439350,   -0.06772373934860,
        0.01451882784960,   0.14663033272250,   -0.05993343088070,  0.03984732989900,
        -12.35427707678840, 0.48662399840100,   -9.65250777468960,  -1.76393422161400,
        0.00000000000000,   0.00000000000000,   0.00323946322590,   -0.06772373934860,
        0.29361499196620,   0.20859209126820,   0.18590490309220,   -0.06410098764490,
        -0.07392352909240,  3.99887350516300,   1.55346437103900,   -2.70725220335860,
        0.08154024882090,   0.00000000000000,   0.00000000000000,   -0.03573628443570,
        0.01451882784960,   0.20859209126820,   0.96377758233810,   -0.02338443310920,
        0.07198551355930,   0.05051248152630,   8.29253671787570,   10.25257726032730,
        -10.00008021424920, 0.40307732930370,   0.00000000000000,   0.00000000000000,
        -0.16578046094900,  0.14663033272250,   0.18590490309220,   -0.02338443310920,
        1.55709714044770,   -0.15132871428870,  0.01772432758650,   0.04528128185340,
        -0.56664272671390,  0.55641525727030,   0.00302817334340,   0.00880145090770,
        -0.18656305856190,  -0.00407823086160,  -0.05993343088070,  -0.06410098764490,
        0.07198551355930,   -0.15132871428870,  1.15126881850090,   0.08818142812630,
        -0.09316465448670,  0.23454779011470,   -0.22197527179970,  -0.03409427723340,
        0.00000000000000,   0.00000000000000,   -0.08940817458020,  0.03984732989900,
        -0.07392352909240,  0.05051248152630,   0.01772432758650,   0.08818142812630,
        1.23541932055910,   -0.26835069218600,  0.13294521353960,   0.09474102861870,
        -0.00846569669010,  0.00000000000000,   0.00000000000000,   -6.20764780018850,
        -12.35427707678840, 3.99887350516300,   8.29253671787570,   0.04528128185340,
        -0.09316465448670,  -0.26835069218600,  284.09835446664000, 22.25984418277860,
        8.82338601639780,   24.92220558380130,  0.00000000000000,   0.00000000000000,
        8.19997396823400,   0.48662399840100,   1.55346437103900,   10.25257726032730,
        -0.56664272671390,  0.23454779011470,   0.13294521353960,   22.25984418277860,
        196.13202571783900, -79.28767999308460, 5.19097125479250,   0.00000000000000,
        0.00000000000000,   2.74637204206120,   -9.65250777468960,  -2.70725220335860,
        -10.00008021424920, 0.55641525727030,   -0.22197527179970,  0.09474102861870,
        8.82338601639780,   -79.28767999308460, 223.39131162140300, 15.91653552891990,
        0.00000000000000,   0.00000000000000,   0.12583276427580,   -1.76393422161400,
        0.08154024882090,   0.40307732930370,   0.00302817334340,   -0.03409427723340,
        -0.00846569669010,  24.92220558380130,  5.19097125479250,   15.91653552891990,
        4.65325468409030,   0.00000000000000,   0.00000000000000,   0.00000000000000,
        0.00000000000000,   0.00000000000000,   0.00000000000000,   0.00880145090770,
        0.00000000000000,   0.00000000000000,   0.00000000000000,   0.00000000000000,
        0.00000000000000,   0.00000000000000,   92.22117924418530,  0.00000000000000,
        0.00000000000000,   0.00000000000000,   0.00000000000000,   0.00000000000000,
        -0.18656305856190,  0.00000000000000,   0.00000000000000,   0.00000000000000,
        0.00000000000000,   0.00000000000000,   0.00000000000000,   0.00000000000000,
        296.11524043861500
    };

    // Act
    ekf_matrix_predict(&state, P_flat, &input, Q.pData, dt);

    // Assert
    double tolerance = 1e-6;

    // check x
    for (int i = 0; i < SIZE_STATE; i++) {
        EXPECT_NEAR(state.array[i], expected_state.array[i], tolerance);
    }

    // check P
    for (int i = 0; i < SIZE_STATE * SIZE_STATE; i++) {
        EXPECT_NEAR(P_flat[i], expected_P_flat[i], tolerance);
    }

    // do it again!

    // Arrange
    x_state_t state2 = {
        .array = {
            0.814723686393179,
            0.905791937075619,
            0.126986816293506,
            0.913375856139019,
            0.632359246225410,
            0.097540404999410,
            0.278498218867048,
            0.546881519204984,
            0.957506835434298,
            0.964888535199277,
            0.157613081677548,
            0.970592781760616,
            0.957166948242946
        }
    };
    double P_flat2[SIZE_STATE * SIZE_STATE] = {
        0.81472368639318, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.90579193707562,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.12698681629351, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.91337585613902, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.63235924622541, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.09754040499941, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.27849821886705,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.54688151920498, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.95750683543430, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.96488853519928, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.15761308167755, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.97059278176062,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.95716694824295
    };

    // Act
    ekf_matrix_predict(&state2, P_flat2, &input, Q.pData, dt);

    // Assert
    // check x
    for (int i = 0; i < SIZE_STATE; i++) {
        EXPECT_NEAR(state2.array[i], expected_state.array[i], tolerance);
    }

    // check P
    for (int i = 0; i < SIZE_STATE * SIZE_STATE; i++) {
        EXPECT_NEAR(P_flat2[i], expected_P_flat[i], tolerance);
    }
}

TEST_F(EstimatorEKFTest, EKFCorrectNominalCheck) {
    // Arrange
    // Initial state estimate
    x_state_t state = {
        .array = {
            8.834741558736747,
            1.407644570039071,
            7.699705252613202,
            5.802880831830792,
            3.386449892509485,
            1.718313257126727,
            3.854276936814474,
            4.338198549286707,
            1.085504519674461,
            5.305567362255530,
            2.035689117774082,
            3.461572119324697,
            5.246877444729065
        }
    };

    // Covariance matrix

    double P_flat[SIZE_STATE * SIZE_STATE] = {
        0.25180612247231, 0.26072799905547, 0.63853075827184, 0.61095865874620, 0.63770909807217,
        0.78051965273136, 0.47135715371061, 0.76550001662144, 0.20893492242602, 0.83291681907522,
        0.54471611052676, 0.76350464084881, 0.39345636121527, 0.29044066427698, 0.59435625066433,
        0.03360383606643, 0.77880224182409, 0.95769393984158, 0.67533206574700, 0.03576273326912,
        0.18866197679149, 0.70928170271055, 0.25644099222915, 0.64731148029313, 0.62789637961417,
        0.67143113967403, 0.61709088439322, 0.02251259274023, 0.06880609911805, 0.42345291896274,
        0.24070703548016, 0.00671531431848, 0.17587441568353, 0.28749817306613, 0.23623057699380,
        0.61346073681288, 0.54388593399964, 0.77198038555425, 0.74125794345421, 0.26528090981003,
        0.42525932021414, 0.31959973518050, 0.09082328578744, 0.67612230386375, 0.60217048758180,
        0.72175803339110, 0.09111346368654, 0.11939624779731, 0.58224916452723, 0.72104662057981,
        0.93285357027882, 0.52005246739039, 0.82437626668884, 0.31271888682062, 0.53086428069413,
        0.26647149077907, 0.28906457167448, 0.38677119452099, 0.47348599296532, 0.57620938066301,
        0.60730394068564, 0.54073933712441, 0.52249530577710, 0.97274085400301, 0.34771267127753,
        0.98266339972195, 0.16148474431175, 0.65444570775707, 0.15365671759131, 0.67180816541422,
        0.91599124413143, 0.15272120043823, 0.68336324329465, 0.45013769696590, 0.86994103235801,
        0.99370462412085, 0.19202834942778, 0.14999725383168, 0.73024879226760, 0.17876618675237,
        0.40761919704115, 0.28100530253387, 0.69514049955174, 0.00115105712911, 0.34112460704911,
        0.54659311459032, 0.45872549364887, 0.26477902647563, 0.21867663239963, 0.13887420282916,
        0.58609206723146, 0.34387700411498, 0.42288568910009, 0.81998122278194, 0.44008513900172,
        0.06799276847001, 0.46244915924233, 0.60738921376835, 0.42572884187119, 0.66194475190565,
        0.31807407548106, 0.10579827325023, 0.69626633708300, 0.26214531772781, 0.58406933327845,
        0.09422933888774, 0.71835894320588, 0.52714274176065, 0.25479015659701, 0.42434903981538,
        0.19174525546180, 0.64444278143134, 0.77028551480366, 0.11921454105419, 0.10969746452319,
        0.09382002677487, 0.04445409227824, 0.10776901524374, 0.59852366875674, 0.96864933023109,
        0.45742436568767, 0.22404003082422, 0.46091636602896, 0.73842683997694, 0.64761763017268,
        0.35021801344111, 0.93982947034492, 0.06359137097511, 0.52540440385934, 0.75493326723118,
        0.90630815064973, 0.47092425635833, 0.53133390656567, 0.87537159860419, 0.66783272701372,
        0.77015972860861, 0.24284959831817, 0.67901675409320, 0.66200959835914, 0.64555187497252,
        0.40457999585763, 0.53034421839286, 0.24278535782096, 0.87965372448191, 0.69594931330161,
        0.32514568182056, 0.51805210836110, 0.84439215652721, 0.32247180718678, 0.91742434204938,
        0.63578671051408, 0.41615858996980, 0.47946322494889, 0.44837291206650, 0.86113981139333,
        0.44240231300194, 0.81776055937064, 0.69988784992829, 0.10562920332902, 0.94362262454839,
        0.34446241130104, 0.78473929476074, 0.26906158668602, 0.94517411310940, 0.84192915269131,
        0.63931696104011, 0.36581617683817, 0.48485333355210, 0.68779608512011
    };

    // Input IMU measurements
    y_imu_t imu = {
        .array = {
            0.359228210401861,
            0.736340074301202,
            0.394707475278763,
            0.683415866967978,
            0.704047430334266,
            0.442305413383371,
            0.019577623553319,
            0.330857880214071,
            0.424309496833137,
            0.270270423432065
        }
    };

    // Bias vector for IMU (mapping to y_imu_t)
    const y_imu_t bias = {
        .array = {
            0.591161394286367,
            2.465163554883929,
            1.289764228149799,
            2.663312862769061,
            1.173548986383490,
            2.307343162164887,
            1.190374551040850,
            2.425542287662036,
            2.265231297021251,
            1.132186634505309
        }
    };

    static double R_MTI_arr[SIZE_IMU_MEAS * SIZE_IMU_MEAS] = {};
    static arm_matrix_instance_f64 R_MTI = {
        .numRows = SIZE_IMU_MEAS, .numCols = SIZE_IMU_MEAS, .pData = R_MTI_arr
    };
    static const double R_MTI_diag[SIZE_IMU_MEAS] = {1e-6, 1e-6, 1e-6, 2e-3, 2e-3, 2e-3, 2e1};
    math_init_matrix_diag(&R_MTI, (uint16_t)SIZE_IMU_MEAS, R_MTI_diag);

    // Expected corrected state (xhat) and covariance (Phat)
    x_state_t expected_state = {
        .array = {
            0.72315179450000,
            -0.15390871663000,
            -0.38112611298000,
            -0.55507339611000,
            -1.97068056688000,
            -0.63282447747000,
            -1.89832759151000,
            7987.27283767854000,
            11685.89820384050000,
            6024.97702279811000,
            11059.94689029680000,
            -1264.10889620298000,
            9434.24369029872000
        }
    };

    double expected_P_flat[169] = {
        -0.16396255074395, 0.03495751908739,  0.08672028408696,  0.12620379782192,
        -0.00000809067585, 0.00000137398097,  0.00000042183882,  0.26213780497346,
        0.25427243989969,  -0.00249551696389, 0.11395888110983,  0.46136241123118,
        0.22930103902575,  0.03503976349687,  -0.00736552405380, -0.01852125856406,
        -0.02695394709101, 0.00000172314187,  -0.00000029281898, -0.00000008978920,
        -0.05597027475325, -0.05409126918875, 0.00041995553881,  -0.02430614853491,
        -0.09834752260402, -0.04893439227848, 0.08680852953652,  -0.01849662495095,
        -0.04578459916873, -0.06677652497917, 0.00000427720254,  -0.00000072725777,
        -0.00000022382057, -0.13853815188638, -0.13439591749749, 0.00132149947985,
        -0.06025664934986, -0.24401708937903, -0.12129174004414, 0.12617133534154,
        -0.02688377156829, -0.06669150752752, -0.09695540889872, 0.00000622356294,
        -0.00000105617483, -0.00000032429401, -0.20157530026788, -0.19555885977918,
        0.00197766069164,  -0.08767210026043, -0.35481112668749, -0.17633260413535,
        -0.00000079801745, 0.00000017014635,  0.00000042208529,  0.00000061338650,
        0.00001000015150,  -0.00000000002891, -0.00000000013220, 0.00000073164066,
        -0.00000127185447, -0.00000096226999, 0.00000015143230,  -0.00000980189315,
        0.00000414867627,  -0.00000407069203, 0.00000086984403,  0.00000215253040,
        0.00000312995401,  0.00000000017249,  0.00000999998581,  0.00000000008621,
        -0.00000097731929, -0.00000723883622, 0.00000403010376,  -0.00000268155339,
        -0.00000690727279, -0.00001028446033, -0.00000425621897, 0.00000090917233,
        0.00000224922254,  0.00000327191727,  0.00000000003261,  0.00000000010690,
        0.00001000001443,  0.00000100836692,  -0.00000613575308, 0.00000654756187,
        -0.00000054632499, 0.00001296412907,  0.00000534283251,  -0.31393762093437,
        0.06694747656215,  0.16592362482394,  0.24149896407703,  0.00000668640076,
        -0.00000277570412, -0.00000059216964, -0.06042528736801, 0.33046190500362,
        -0.05049781718864, 0.13122185349396,  0.12295369628181,  0.53161351440712,
        -0.23116725617778, 0.04925183935111,  0.12220419933821,  0.17781541540994,
        -0.00000680262434, 0.00000211001385,  0.00000304374308,  0.05082471562390,
        0.69949203746536,  -0.39623303553396, 0.19198707532860,  0.49160274523172,
        0.36770238895997,  -0.50684171426628, 0.10814115111280,  0.26787280862271,
        0.38987778014886,  0.00000941370280,  -0.00000338480223, 0.00000178510974,
        0.19636069192908,  -0.10900239360558, 0.74705968343925,  0.09900308926908,
        -0.07912511129393, 0.98782317726746,  0.03511171933549,  -0.00751179017128,
        -0.01857960995752, -0.02700034209335, -0.00000230445073, -0.00000072567838,
        0.00000081103656,  0.01578972775593,  0.07131787163751,  0.06820519796108,
        0.18169443987829,  0.21161160903077,  0.14333884189231,  0.29189325106294,
        -0.06225014711293, -0.15432424736473, -0.22445812571282, 0.00001212093737,
        -0.00000856739198, 0.00000454853485,  0.06369766910305,  -0.47691728362738,
        0.06475833563651,  -0.02070844423825, -0.87796954784308, -0.61437512938151,
        0.29900843489038,  -0.06378446014531, -0.15809766891366, -0.22998858133548,
        0.00000826627490,  -0.00000709651469, -0.00000739082246, 0.54145397880772,
        -0.01421572762965, 0.24893095461501,  0.15492082999653,  -0.83138638404697,
        0.47087460507077
    };

    // Act: Run the EKF correction step
    // y_meas is IMU_1(4:end)
    ekf_matrix_correct(&state, P_flat, &R_MTI, &imu, &bias);

    // Assert
    double tolerance = 1e-6;

    // Check state (x)
    for (int i = 0; i < SIZE_STATE; i++) {
        EXPECT_NEAR(state.array[i], expected_state.array[i], tolerance);
    }

    // Check covariance (P)
    for (int i = 0; i < SIZE_STATE * SIZE_STATE; i++) {
        EXPECT_NEAR(P_flat[i], expected_P_flat[i], tolerance);
    }

    // do it again!

    // Arrange
    // Initial state estimate
    x_state_t state2 = {
        .array = {
            8.834741558736747,
            1.407644570039071,
            7.699705252613202,
            5.802880831830792,
            3.386449892509485,
            1.718313257126727,
            3.854276936814474,
            4.338198549286707,
            1.085504519674461,
            5.305567362255530,
            2.035689117774082,
            3.461572119324697,
            5.246877444729065
        }
    };

    // Covariance matrix

    double P_flat2[SIZE_STATE * SIZE_STATE] = {
        0.25180612247231, 0.26072799905547, 0.63853075827184, 0.61095865874620, 0.63770909807217,
        0.78051965273136, 0.47135715371061, 0.76550001662144, 0.20893492242602, 0.83291681907522,
        0.54471611052676, 0.76350464084881, 0.39345636121527, 0.29044066427698, 0.59435625066433,
        0.03360383606643, 0.77880224182409, 0.95769393984158, 0.67533206574700, 0.03576273326912,
        0.18866197679149, 0.70928170271055, 0.25644099222915, 0.64731148029313, 0.62789637961417,
        0.67143113967403, 0.61709088439322, 0.02251259274023, 0.06880609911805, 0.42345291896274,
        0.24070703548016, 0.00671531431848, 0.17587441568353, 0.28749817306613, 0.23623057699380,
        0.61346073681288, 0.54388593399964, 0.77198038555425, 0.74125794345421, 0.26528090981003,
        0.42525932021414, 0.31959973518050, 0.09082328578744, 0.67612230386375, 0.60217048758180,
        0.72175803339110, 0.09111346368654, 0.11939624779731, 0.58224916452723, 0.72104662057981,
        0.93285357027882, 0.52005246739039, 0.82437626668884, 0.31271888682062, 0.53086428069413,
        0.26647149077907, 0.28906457167448, 0.38677119452099, 0.47348599296532, 0.57620938066301,
        0.60730394068564, 0.54073933712441, 0.52249530577710, 0.97274085400301, 0.34771267127753,
        0.98266339972195, 0.16148474431175, 0.65444570775707, 0.15365671759131, 0.67180816541422,
        0.91599124413143, 0.15272120043823, 0.68336324329465, 0.45013769696590, 0.86994103235801,
        0.99370462412085, 0.19202834942778, 0.14999725383168, 0.73024879226760, 0.17876618675237,
        0.40761919704115, 0.28100530253387, 0.69514049955174, 0.00115105712911, 0.34112460704911,
        0.54659311459032, 0.45872549364887, 0.26477902647563, 0.21867663239963, 0.13887420282916,
        0.58609206723146, 0.34387700411498, 0.42288568910009, 0.81998122278194, 0.44008513900172,
        0.06799276847001, 0.46244915924233, 0.60738921376835, 0.42572884187119, 0.66194475190565,
        0.31807407548106, 0.10579827325023, 0.69626633708300, 0.26214531772781, 0.58406933327845,
        0.09422933888774, 0.71835894320588, 0.52714274176065, 0.25479015659701, 0.42434903981538,
        0.19174525546180, 0.64444278143134, 0.77028551480366, 0.11921454105419, 0.10969746452319,
        0.09382002677487, 0.04445409227824, 0.10776901524374, 0.59852366875674, 0.96864933023109,
        0.45742436568767, 0.22404003082422, 0.46091636602896, 0.73842683997694, 0.64761763017268,
        0.35021801344111, 0.93982947034492, 0.06359137097511, 0.52540440385934, 0.75493326723118,
        0.90630815064973, 0.47092425635833, 0.53133390656567, 0.87537159860419, 0.66783272701372,
        0.77015972860861, 0.24284959831817, 0.67901675409320, 0.66200959835914, 0.64555187497252,
        0.40457999585763, 0.53034421839286, 0.24278535782096, 0.87965372448191, 0.69594931330161,
        0.32514568182056, 0.51805210836110, 0.84439215652721, 0.32247180718678, 0.91742434204938,
        0.63578671051408, 0.41615858996980, 0.47946322494889, 0.44837291206650, 0.86113981139333,
        0.44240231300194, 0.81776055937064, 0.69988784992829, 0.10562920332902, 0.94362262454839,
        0.34446241130104, 0.78473929476074, 0.26906158668602, 0.94517411310940, 0.84192915269131,
        0.63931696104011, 0.36581617683817, 0.48485333355210, 0.68779608512011
    };

    // Input IMU measurements
    y_imu_t imu2 = {
        .array = {
            0.359228210401861,
            0.736340074301202,
            0.394707475278763,
            0.683415866967978,
            0.704047430334266,
            0.442305413383371,
            0.019577623553319,
            0.330857880214071,
            0.424309496833137,
            0.270270423432065
        }
    };

    // Bias vector for IMU (mapping to y_imu_t)
    const y_imu_t bias2 = {
        .array = {
            0.591161394286367,
            2.465163554883929,
            1.289764228149799,
            2.663312862769061,
            1.173548986383490,
            2.307343162164887,
            1.190374551040850,
            2.425542287662036,
            2.265231297021251,
            1.132186634505309
        }
    };

    // Act: Run the EKF correction step
    // y_meas is IMU_1(4:end)
    ekf_matrix_correct(&state2, P_flat2, &R_MTI, &imu2, &bias2);

    // Assert
    // Check state (x)
    for (int i = 0; i < SIZE_STATE; i++) {
        EXPECT_NEAR(state2.array[i], expected_state.array[i], tolerance);
    }

    // Check covariance (P)
    for (int i = 0; i < SIZE_STATE * SIZE_STATE; i++) {
        EXPECT_NEAR(P_flat2[i], expected_P_flat[i], tolerance);
    }
}

TEST_F(EstimatorEKFTest, EKFAlgorithmSelectIMU1) {
    // Arrange
    // Initial state estimate
    x_state_t state = {
        .array = {
            2.426878243614206,
            4.001402344444001,
            0.709431693136077,
            2.108806413131375,
            4.578677625945335,
            3.961036647797772,
            4.797462131964515,
            3.278703495782934,
            0.178558392870948,
            4.245646529343886,
            4.669966238787753,
            3.393675774288867,
            3.788700652891667
        }
    };

    // Covariance matrix

    double P_flat[SIZE_STATE * SIZE_STATE] = {
        2.95219117313746, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.50150522974397,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.31864903478599, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 1.11722922016661, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.59435520762892, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        1.46906291404807, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 1.01848024017227,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 2.85489139433318, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 2.76099611950969, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.15803099304238, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        2.21357428655099, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.80735827919567,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 1.26850684502642
    };

    // Input IMU measurements
    y_imu_t imu_1 = {
        .array = {
            2.711216972515416,
            4.238310136658316,
            2.074393441904026,
            7.598779134258502,
            1.752878606103443,
            2.033296028751589,
            1.536372424330727,
            2.048978680348982,
            3.921288156935092,
            2.799920579853715
        }
    };

    // Bias vector for IMU (mapping to y_imu_t)
    y_imu_t bias_1 = {
        .array = {
            0.942736984276934,
            0.417744104316662,
            0.983052466469856,
            0.301454948712065,
            0.701098755900926,
            0.666338851584426,
            0.539126465042857,
            0.698105520180308,
            0.666527913402587,
            0.178132454400338
        }
    };

    // Input IMU measurements
    y_imu_t imu_2 = {
        .array = {
            7.387037136825951,
            3.441659130636672,
            1.478530560993089,
            7.239047749439143,
            7.837987026848682,
            3.510959785008826,
            0.888953787524790,
            2.064517567296535,
            3.269758768900417,
            4.759168592068915
        }
    };

    // Bias vector for IMU (mapping to y_imu_t)
    y_imu_t bias_2 = {
        .array = {
            0.128014399720173,
            0.999080394761361,
            0.171121066356432,
            0.032600820530528,
            0.561199792709660,
            0.881866500451810,
            0.669175304534394,
            0.190433267179954,
            0.368916546063895,
            0.460725937260412
        }
    };

    const double cmd = 0.547870901214845;
    const double encoder = 0.431651170248720; // this is unused
    const double dt = 1.038711463665142;
    const bool is_dead_mti = false;
    const bool is_dead_altimu = true;

    // Expected corrected state (xhat) and covariance (Phat)
    x_state_t expected_state = {
        .array = {
            0.59917796378000,
            -0.09777177477000,
            0.53904603831000,
            0.58382858474000,
            7.29769096915000,
            1.05220713395000,
            1.36718468827000,
            223.19129440145000,
            17997.47564780780000,
            2605.38128096077000,
            8414.62758161536000,
            -12.24127211692000,
            487.37701868611000
        }
    };

    double expected_P_flat[169] = {
        0.37665372579190,   -0.06154403688320,  0.33786280367470,   0.36640077069240,
        -0.00000072667450,  -0.00000077427700,  -0.00000104490770,  -2.25910824167600,
        0.47672755303440,   3.58973676781860,   0.03920173818740,   0.03107235764440,
        -1.09147518621820,  -0.06154403688320,  0.01110604170150,   -0.05535593688680,
        -0.06003144880270,  0.00000011879090,   0.00000012655870,   0.00000017090130,
        0.36650570151300,   -0.08118757975030,  -0.58673402409510,  -0.00640844624230,
        -0.00507945709370,  0.17842551378690,   0.33786280367470,   -0.05535593688680,
        0.30491422472790,   0.32955985677110,   -0.00000065286380,  -0.00000069571470,
        -0.00000093881050,  -2.02744025981490,  0.43138389699140,   3.22003327921800,
        0.03522211246440,   0.02791623814900,   -0.98061053431870,  0.36640077069240,
        -0.06003144880270,  0.32955985677110,   0.35841822121630,   -0.00000070714510,
        -0.00000075342770,  -0.00000101696660,  -2.20224654132250,  0.47194022857120,
        3.48980537273590,   0.03815333228370,   0.03023728500320,   -1.06214168417050,
        -0.00000072667450,  0.00000011879090,   -0.00000065286380,  -0.00000070714510,
        0.00000999998470,   -0.00000000001170,  -0.00000000001590,  0.00000506240920,
        -0.00000385018620,  -0.00000073182150,  0.00000000600440,   0.00000065302460,
        -0.00002293872110,  -0.00000077427700,  0.00000012655870,   -0.00000069571470,
        -0.00000075342770,  -0.00000000001170,  0.00000999998810,   -0.00000000001310,
        0.00000487668580,   0.00000210871230,   0.00000019649220,   0.00000000692440,
        0.00000050171250,   -0.00001762359790,  -0.00000104490770,  0.00000017090130,
        -0.00000093881050,  -0.00000101696660,  -0.00000000001590,  -0.00000000001310,
        0.00000999998100,   -0.00000139847620,  -0.00000099989960,  0.00000444356340,
        0.00000000374030,   0.00000067872080,   -0.00002384134940,  -2.25910824167600,
        0.36650570151300,   -2.02744025981490,  -2.20224654132250,  0.00000506240920,
        0.00000487668580,   -0.00000139847620,  81.67080501257360,  -21.04318843788410,
        -76.85434372485160, 0.00416904472490,   -0.21646691666150,  7.60380885407020,
        0.47672755303440,   -0.08118757975030,  0.43138389699130,   0.47194022857120,
        -0.00000385018620,  0.00000210871230,   -0.00000099989960,  -21.04318843788410,
        73.18107379113040,  -28.05890031911250, 0.29615154883980,   0.16463267015440,
        -5.78303315026390,  3.58973676781860,   -0.58673402409510,  3.22003327921800,
        3.48980537273590,   -0.00000073182150,  0.00000019649220,   0.00000444356340,
        -76.85434372485160, -28.05890031911250, 117.59670768440600, 0.04270739324020,
        0.03129244289220,   -1.09920609577980,  0.03920173818740,   -0.00640844624230,
        0.03522211246440,   0.03815333228370,   0.00000000600440,   0.00000000692440,
        0.00000000374030,   0.00416904472490,   0.29615154883980,   0.04270739324020,
        0.13835118909310,   -0.00025674632060,  0.00901869891130,   0.03107235764440,
        -0.00507945709370,  0.02791623814900,   0.03023728500320,   0.00000065302460,
        0.00000050171250,   0.00000067872080,   -0.21646691666150,  0.16463267015440,
        0.03129244289220,   -0.00025674632060,  104.34997966163500, 0.98085200883940,
        -1.09147518621820,  0.17842551378690,   -0.98061053431870,  -1.06214168417050,
        -0.00002293872110,  -0.00001762359790,  -0.00002384134940,  7.60380885407020,
        -5.78303315026390,  -1.09920609577980,  0.00901869891130,   0.98085200883940,
        471.94456564750700
    };

    // Act: Run the EKF correction step
    // y_meas is IMU_1(4:end)
    ekf_algorithm(
        &state,
        P_flat,
        &imu_1,
        &bias_1,
        &imu_2,
        &bias_2,
        cmd,
        encoder,
        dt,
        is_dead_mti,
        is_dead_altimu
    );

    // Assert
    double tolerance = 1e-6;

    // Check state (x)
    for (int i = 0; i < SIZE_STATE; i++) {
        EXPECT_NEAR(state.array[i], expected_state.array[i], tolerance);
    }

    // Check covariance (P)
    for (int i = 0; i < SIZE_STATE * SIZE_STATE; i++) {
        EXPECT_NEAR(P_flat[i], expected_P_flat[i], tolerance);
    }
}

TEST_F(EstimatorEKFTest, EKFAlgorithmSelectIMU2) {
    // Arrange
    // Initial state estimate
    x_state_t state = {
        .array = {
            2.426878243614206,
            4.001402344444001,
            0.709431693136077,
            2.108806413131375,
            4.578677625945335,
            3.961036647797772,
            4.797462131964515,
            3.278703495782934,
            0.178558392870948,
            4.245646529343886,
            4.669966238787753,
            3.393675774288867,
            3.788700652891667
        }
    };

    // Covariance matrix

    double P_flat[SIZE_STATE * SIZE_STATE] = {
        2.95219117313746, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.50150522974397,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.31864903478599, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 1.11722922016661, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.59435520762892, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        1.46906291404807, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 1.01848024017227,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 2.85489139433318, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 2.76099611950969, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.15803099304238, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        2.21357428655099, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.80735827919567,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 1.26850684502642
    };

    // Input IMU measurements
    y_imu_t imu_1 = {
        .array = {
            2.711216972515416,
            4.238310136658316,
            2.074393441904026,
            7.598779134258502,
            1.752878606103443,
            2.033296028751589,
            1.536372424330727,
            2.048978680348982,
            3.921288156935092,
            2.799920579853715
        }
    };

    // Bias vector for IMU (mapping to y_imu_t)
    y_imu_t bias_1 = {
        .array = {
            0.942736984276934,
            0.417744104316662,
            0.983052466469856,
            0.301454948712065,
            0.701098755900926,
            0.666338851584426,
            0.539126465042857,
            0.698105520180308,
            0.666527913402587,
            0.178132454400338
        }
    };

    // Input IMU measurements
    y_imu_t imu_2 = {
        .array = {
            7.387037136825951,
            3.441659130636672,
            1.478530560993089,
            7.239047749439143,
            7.837987026848682,
            3.510959785008826,
            0.888953787524790,
            2.064517567296535,
            3.269758768900417,
            4.759168592068915
        }
    };

    // Bias vector for IMU (mapping to y_imu_t)
    y_imu_t bias_2 = {
        .array = {
            0.128014399720173,
            0.999080394761361,
            0.171121066356432,
            0.032600820530528,
            0.561199792709660,
            0.881866500451810,
            0.669175304534394,
            0.190433267179954,
            0.368916546063895,
            0.460725937260412
        }
    };

    const double cmd = 0.547870901214845;
    const double encoder = 0.431651170248720; // this is unused
    const double dt = 1.038711463665142;
    const bool is_dead_mti = true;
    const bool is_dead_altimu = false;

    // Expected corrected state (xhat) and covariance (Phat)
    x_state_t expected_state = {
        .array = {
            0.61497456353900,
            0.39815027513800,
            0.58139688957900,
            0.35392132091100,
            7.20656256145700,
            7.27681102226400,
            2.62910823126500,
            -2709.86632358178000,
            9286.12599251448000,
            3722.17688375059000,
            8423.39602822847000,
            0.97006700248800,
            23.30380639313800
        }
    };

    double expected_P_flat[169] = {
        0.36953796755230,   0.23877697692930,   0.34880437033180,   0.21217080620990,
        -0.00000147944690,  -0.00000160298880,  -0.00000206079500,  -2.60870768085100,
        -0.83796789849430,  3.60812035949200,   0.05941020506640,   0.03163032577020,
        -1.11107486935200,  0.23877697692930,   0.15485724642110,   0.22562600224040,
        0.13724380082000,   -0.00000095622130,  -0.00000103610350,  -0.00000133190580,
        -1.68751617892320,  -0.54232554888450,  2.33115553649470,   0.03839996191880,
        0.02044385077000,   -0.71812882953960,  0.34880437033180,   0.22562600224040,
        0.32999665272470,   0.20048521068980,   -0.00000139733040,  -0.00000151409300,
        -0.00000194641380,  -2.46318367840660,  -0.79075511963330,  3.40577341524040,
        0.05611384932780,   0.02987469008210,   -1.04940485346430,  0.21217080620990,
        0.13724380082000,   0.20048521068980,   0.12235424577280,   -0.00000084953720,
        -0.00000092045720,  -0.00000118341510,  -1.49960232090230,  -0.47940075606170,
        2.07093366533260,   0.03411710562940,   0.01816296197720,   -0.63800830735940,
        -0.00000147944690,  -0.00000095622130,  -0.00000139733040,  -0.00000084953720,
        0.00001999993930,   -0.00000000004640,  -0.00000000006320,  0.00001199112300,
        -0.00000236092860,  -0.00000224886040,  0.00000000320900,   0.00000129731220,
        -0.00004557053950,  -0.00000160298880,  -0.00000103610350,  -0.00000151409300,
        -0.00000092045720,  -0.00000000004640,  0.00001999995320,   -0.00000000005170,
        0.00001193104390,   0.00000996771640,   -0.00000070473710,  0.00000000069770,
        0.00000099182720,   -0.00003483980010,  -0.00000206079500,  -0.00000133190580,
        -0.00000194641380,  -0.00000118341510,  -0.00000000006320,  -0.00000000005170,
        0.00001999992410,   -0.00000059173010,  0.00000551966850,   0.00000841907310,
        0.00000000086980,   0.00000135069900,   -0.00004744585070,  -2.60870768085100,
        -1.68751617892320,  -2.46318367840660,  -1.49960232090240,  0.00001199112300,
        0.00001193104390,   -0.00000059173010,  86.72995987168520,  -12.04992961706080,
        -81.07972274929810, -0.06619329123830,  -0.25636819607590,  9.00541657491390,
        -0.83796789849430,  -0.54232554888450,  -0.79075511963330,  -0.47940075606170,
        -0.00000236092860,  0.00000996771640,   0.00000551966850,   -12.04992961706080,
        74.66189309842910,  -41.06720257628250, 0.22906891769980,   0.05047625646050,
        -1.77307374131050,  3.60812035949200,   2.33115553649470,   3.40577341524040,
        2.07093366533260,   -0.00000224886040,  -0.00000070473710,  0.00000841907310,
        -81.07972274929810, -41.06720257628250, 118.99975499012500, 0.09161309374340,
        0.04808025845130,   -1.68890979072750,  0.05941020506640,   0.03839996191880,
        0.05611384932780,   0.03411710562940,   0.00000000320900,   0.00000000069770,
        0.00000000086980,   -0.06619329123830,  0.22906891769980,   0.09161309374340,
        0.20774709802150,   -0.00006860721650,  0.00240995791920,   0.03163032577020,
        0.02044385077000,   0.02987469008210,   0.01816296197720,   0.00000129731220,
        0.00000099182720,   0.00000135069900,   -0.25636819607590,  0.05047625646050,
        0.04808025845130,   -0.00006860721650,  104.35016645667700, 0.97429048054090,
        -1.11107486935200,  -0.71812882953960,  -1.04940485346430,  -0.63800830735940,
        -0.00004557053950,  -0.00003483980010,  -0.00004744585070,  9.00541657491380,
        -1.77307374131050,  -1.68890979072750,  0.00240995791920,   0.97429048054090,
        472.17505170857400
    };

    // Act: Run the EKF correction step
    // y_meas is IMU_1(4:end)
    ekf_algorithm(
        &state,
        P_flat,
        &imu_1,
        &bias_1,
        &imu_2,
        &bias_2,
        cmd,
        encoder,
        dt,
        is_dead_mti,
        is_dead_altimu
    );

    // Assert
    double tolerance = 1e-6;

    // Check state (x)
    for (int i = 0; i < SIZE_STATE; i++) {
        EXPECT_NEAR(state.array[i], expected_state.array[i], tolerance);
    }

    // Check covariance (P)
    for (int i = 0; i < SIZE_STATE * SIZE_STATE; i++) {
        EXPECT_NEAR(P_flat[i], expected_P_flat[i], tolerance);
    }
}

// clang-format off
/*
clear persistent;

% Define state vector
x = [ ...
    2.426878243614206;
    4.001402344444001;
    0.709431693136077;
    2.108806413131375;
    4.578677625945335;
    3.961036647797772;
    4.797462131964515;
    3.278703495782934;
    0.178558392870948;
    4.245646529343886;
    4.669966238787753;
    3.393675774288867;
    3.788700652891667
];

% Define corrected diagonal covariance matrix P (13x13)
P = diag([ ...
    2.95219117313746;
    0.50150522974397;
    0.31864903478599;
    1.11722922016661;
    0.59435520762892;
    1.46906291404807;
    1.01848024017227;
    2.85489139433318;
    2.76099611950969;
    0.15803099304238;
    2.21357428655099;
    0.80735827919567;
    1.26850684502642
]);

% Correct IMU measurements
IMU_1 = [ ...
    2.711216972515416;
    4.238310136658316;
    2.074393441904026;
    7.598779134258502;
    1.752878606103443;
    2.033296028751589;
    1.536372424330727;
    2.048978680348982;
    3.921288156935092;
    2.799920579853715
];

IMU_2 = [ ...
    7.387037136825951;
    3.441659130636672;
    1.478530560993089;
    7.239047749439143;
    7.837987026848682;
    3.510959785008826;
    0.888953787524790;
    2.064517567296535;
    3.269758768900417;
    4.759168592068915
];

% IMU biases
bias_1 = [ ...
    0.942736984276934;
    0.417744104316662;
    0.983052466469856;
    0.301454948712065;
    0.701098755900926;
    0.666338851584426;
    0.539126465042857;
    0.698105520180308;
    0.666527913402587;
    0.178132454400338
];

bias_2 = [ ...
    0.128014399720173;
    0.999080394761361;
    0.171121066356432;
    0.032600820530528;
    0.561199792709660;
    0.881866500451810;
    0.669175304534394;
    0.190433267179954;
    0.368916546063895;
    0.460725937260412
];

% Bias struct
b.bias_1 = bias_1;
b.bias_2 = bias_2;

% Inputs
cmd = 0.547870901214845;
encoder = 0.431651170248720;
T = 1.038711463665142;

% Global IMU selector
global IMU_select;
IMU_select = [1 1];

% Call EKF (make sure ekf_algorithm.m is available)
[xhat, Phat] = ekf_algorithm(x, P, b, 0, T, IMU_1, IMU_2, cmd, encoder, []);

% Display results
disp('Corrected state x:');
disp(xhat);

disp('Corrected covariance P:');
disp(Phat);

% Assuming xhat and Phat are already computed

% Convert xhat (13x1 vector) into C array format, row-major order
xhat_c = reshape(xhat, 1, []);  % Flatten the vector to a row vector

% Display xhat in C array format
disp('xhat in C array format (row-major):');
fprintf('float xhat[] = { ');
fprintf('%f, ', xhat_c(1:end-1));  % Print all except the last element
fprintf('%f }; \n', xhat_c(end));  % Print the last element

% Convert Phat (13x13 matrix) into C array format, row-major order
Phat_c = reshape(Phat, 1, []);  % Flatten the matrix to a row vector

% Display Phat in C array format
disp('Phat in C array format (row-major):');
fprintf('float Phat[] = { ');
fprintf('%f, ', Phat_c(1:end-1));  % Print all except the last element
fprintf('%f }; \n', Phat_c(end));  % Print the last element

*/
// clang-format on
TEST_F(EstimatorEKFTest, EKFAlgorithmSelectBoth) {
    // Arrange
    // Initial state estimate
    x_state_t state = {
        .array = {
            2.426878243614206,
            4.001402344444001,
            0.709431693136077,
            2.108806413131375,
            4.578677625945335,
            3.961036647797772,
            4.797462131964515,
            3.278703495782934,
            0.178558392870948,
            4.245646529343886,
            4.669966238787753,
            3.393675774288867,
            3.788700652891667
        }
    };

    // Covariance matrix

    double P_flat[SIZE_STATE * SIZE_STATE] = {
        2.95219117313746, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.50150522974397,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.31864903478599, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 1.11722922016661, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.59435520762892, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        1.46906291404807, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 1.01848024017227,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 2.85489139433318, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 2.76099611950969, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.15803099304238, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        2.21357428655099, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.80735827919567,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000, 0.00000000000000,
        0.00000000000000, 0.00000000000000, 0.00000000000000, 1.26850684502642
    };

    // Input IMU measurements
    y_imu_t imu_1 = {
        .array = {
            2.711216972515416,
            4.238310136658316,
            2.074393441904026,
            7.598779134258502,
            1.752878606103443,
            2.033296028751589,
            1.536372424330727,
            2.048978680348982,
            3.921288156935092,
            2.799920579853715
        }
    };

    // Bias vector for IMU (mapping to y_imu_t)
    y_imu_t bias_1 = {
        .array = {
            0.942736984276934,
            0.417744104316662,
            0.983052466469856,
            0.301454948712065,
            0.701098755900926,
            0.666338851584426,
            0.539126465042857,
            0.698105520180308,
            0.666527913402587,
            0.178132454400338
        }
    };

    // Input IMU measurements
    y_imu_t imu_2 = {
        .array = {
            7.387037136825951,
            3.441659130636672,
            1.478530560993089,
            7.239047749439143,
            7.837987026848682,
            3.510959785008826,
            0.888953787524790,
            2.064517567296535,
            3.269758768900417,
            4.759168592068915
        }
    };

    // Bias vector for IMU (mapping to y_imu_t)
    y_imu_t bias_2 = {
        .array = {
            0.128014399720173,
            0.999080394761361,
            0.171121066356432,
            0.032600820530528,
            0.561199792709660,
            0.881866500451810,
            0.669175304534394,
            0.190433267179954,
            0.368916546063895,
            0.460725937260412
        }
    };

    const double cmd = 0.547870901214845;
    const double encoder = 0.431651170248720; // this is unused
    const double dt = 1.038711463665142;
    const bool is_dead_mti = false;
    const bool is_dead_altimu = false;

    // Expected corrected state (xhat) and covariance (Phat)
    x_state_t expected_state = {
        .array = {
            0.685878,
            0.442927,
            0.513805,
            0.263425,
            7.267034,
            3.126807,
            1.787672,
            1382.365573,
            17717.058297,
            2214.221941,
            9076.120244,
            -55.619949,
            2369.883018
        }

    };

    double expected_P_flat[169] = {
        0.000296,  -0.000038,  0.000091,  0.000020,   -0.000000,  -0.000000,  -0.000000, -0.001174,
        0.000183,  0.002422,   0.000026,  0.000035,   -0.001401,  -0.000038,  0.000238,  -0.000043,
        0.000051,  0.000000,   0.000000,  0.000000,   -0.000686,  -0.000437,  -0.000446, -0.000004,
        -0.000006, 0.000240,   0.000091,  -0.000043,  0.000294,   0.000001,   -0.000000, -0.000000,
        -0.000000, -0.000104,  0.000400,  0.000707,   0.000017,   0.000023,   -0.000914, 0.000020,
        0.000051,  0.000001,   0.000391,  0.000000,   0.000000,   -0.000000,  -0.001329, 0.001322,
        -0.000351, -0.000001,  -0.000001, 0.000034,   -0.000000,  0.000000,   -0.000000, 0.000000,
        0.000001,  -0.000000,  -0.000000, -0.000000,  0.000000,   -0.000000,  0.000000,  0.000000,
        -0.000000, -0.000000,  0.000000,  -0.000000,  0.000000,   -0.000000,  0.000001,  -0.000000,
        -0.000000, 0.000001,   0.000000,  0.000000,   0.000000,   -0.000000,  -0.000000, 0.000000,
        -0.000000, -0.000000,  -0.000000, -0.000000,  0.000001,   -0.000001,  0.000000,  0.000000,
        0.000000,  0.000000,   -0.000000, -0.001174,  -0.000686,  -0.000104,  -0.001329, -0.000000,
        -0.000000, -0.000001,  72.234289, -19.032424, -59.380337, 0.219508,   0.040426,  -1.638103,
        0.000183,  -0.000437,  0.000400,  0.001322,   0.000000,   0.000001,   0.000000,  -19.032424,
        50.415860, -19.195568, 0.087566,  -0.974277,  39.478594,  0.002422,   -0.000446, 0.000707,
        -0.000351, -0.000000,  0.000000,  0.000000,   -59.380337, -19.195568, 82.035955, -0.197773,
        0.615535,  -24.942057, 0.000026,  -0.000004,  0.000017,   -0.000001,  0.000000,  0.000000,
        0.000000,  0.219508,   0.087566,  -0.197773,  0.120850,   -0.005305,  0.214981,  0.000035,
        -0.000006, 0.000023,   -0.000001, 0.000000,   0.000000,   0.000000,   0.040426,  -0.974277,
        0.615535,  -0.005305,  1.177361,  1.939572,   -0.001401,  0.000240,   -0.000914, 0.000034,
        -0.000000, -0.000000,  -0.000000, -1.638103,  39.478594,  -24.942057, 0.214981,  1.939572,
        164.339269
    };

    // Act: Run the EKF correction step
    // y_meas is IMU_1(4:end)
    ekf_algorithm(
        &state,
        P_flat,
        &imu_1,
        &bias_1,
        &imu_2,
        &bias_2,
        cmd,
        encoder,
        dt,
        is_dead_mti,
        is_dead_altimu
    );

    // Assert
    double tolerance = 1e-6;

    // Check state (x)
    for (int i = 0; i < SIZE_STATE; i++) {
        EXPECT_NEAR(state.array[i], expected_state.array[i], tolerance);
    }

    // Check covariance (P)
    for (int i = 0; i < SIZE_STATE * SIZE_STATE; i++) {
        EXPECT_NEAR(P_flat[i], expected_P_flat[i], tolerance);
    }
}

